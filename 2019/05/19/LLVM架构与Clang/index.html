<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A developer">
    <meta name="keyword"  content="Jerry, wangjing, Jerry&#39;s Blog, 博客, 个人博客, iOS, 移动互联网, 开发">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          LLVM架构与Clang - Jerry的博客 | Jerry&#39;s Blog
        
    </title>

    <link rel="canonical" href="https://jerrywangjing.github.io/2019/05/19/LLVM架构与Clang/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jerry&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://jerrywangjing.github.io/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('imgs/llvm-logo-bg.png')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#LLVM" title="LLVM">LLVM</a>
                        
                          <a class="tag" href="/tags/#Clang" title="Clang">Clang</a>
                        
                    </div>
                    <h1>LLVM架构与Clang</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Jerry on
                        2019-05-19
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h4 id="LLVM简介"><a href="#LLVM简介" class="headerlink" title="LLVM简介"></a>LLVM简介</h4><p>LLVM是一个模块化的、可重用的编译器和工具链技术的集合。最开始是由克里斯·拉特纳（Chris Lattner）在伊利诺伊大学主导开发的一个研究项目，目的是提供一个现代的、基于SSA编译策略的，能够支持任意编程语言和动态编译的编译器和工具链的集合。</p>
<p>后来，克里斯及其他的团队被苹果雇佣了，为实现苹果系统中的各种用途而开发LLVM系统。 克里斯·拉特纳也是Swift之父，在苹果任职期间主导研发了Swift语言，编译部分也采用了LLVM工具链技术。</p>
<p>LLVM名称最初的由来是低级虚拟机首字母的缩写（Low Level Virtual Machine），后来由于这个解释不能准确的代表当前LLVM编译系统的强大和特别之处，LLVM系统是由众多子系统组成的包括LLVM内核、Clang编译前端、LLDB调试器、libc++标准库等等，所以官方也放弃了这个解释，而LLVM是作为整个系统的全称，这里可以参考LLVM<a href="https://llvm.org/" target="_blank" rel="noopener">官方网站</a>。</p>
<h4 id="传统编译器架构"><a href="#传统编译器架构" class="headerlink" title="传统编译器架构"></a>传统编译器架构</h4><p>传统的静态编译器最流行的就是金典的三段式设计，其主要组件是前端（Frontend）、优化器（Optimiser）、和后端（Backend）。如下图所示：</p>
<p><img src="https://i.loli.net/2019/05/19/5ce0aa3b5c66465936.png" alt="img1"></p>
<ul>
<li>前端（Fontend）： 主要对源代码进行词法分析、语法分析、语义分析并生成具有层级关系的抽象语语法树（AST），最后生成中间代码（IR）</li>
<li>优化器（Optimizer）：优化器负责执行各种各样的转换，以尝试改进代码的运行时间，例如消除冗余代码，这个过程通常是与前后端无关的。</li>
<li>后端（Backend）：主要是根据目标指令集生成机器代码，还可以根据所支持的体系结构特点，来生成适应该架构的优质代码。编译器后端常见的部分包括指令选择、寄存器分配和指令调度。</li>
</ul>
<p>这个模型同样适用于解释器和JIT编译器。Java虚拟机（JVM - Java Virtual Machine）也是这个模型的实现，它使用Java字节码作为前端和优化器之间的接口。</p>
<h4 id="LLVM三段式架构"><a href="#LLVM三段式架构" class="headerlink" title="LLVM三段式架构"></a>LLVM三段式架构</h4><p>LLVM的不同之处在于，可以作为多种前端编译器的优化器，并且可以针对多种CPU架构生成对应的机器代码。其优势就是优化器的功能可重用，适用于多种编程语言和多种CPU架构平台。如下图所示：</p>
<p><img src="https://i.loli.net/2019/05/19/5ce0b27d9a0d211355.png" alt="img2"></p>
<h5 id="这种架构设计的优势："><a href="#这种架构设计的优势：" class="headerlink" title="这种架构设计的优势："></a>这种架构设计的优势：</h5><ul>
<li><strong>可重用</strong>：由于前后端是分离的，当需要移植一个新语言源时，只需要实现一个新的前端，而现有的优化器和后端可以直接重用。</li>
<li><strong>模块化</strong>：不同于其他编译器（如：GCC）的整体式设计，LLVM将各个阶段的编译技术模块化，尤其是语言无关的通用优化器，可支持多种语言输入，可输出多种架构的机器代码。</li>
<li><strong>丰富的开发者资源</strong>：这种设计意味着它支持不止一种源语言和目标平台（如：x86、ARM、MIPS），会吸引更多的开发人员参与到该项目中，就会有更多高质量的代码产生，这自然会对编译器带来更多的增强和改进。</li>
<li><strong>有利于分工</strong>：实现前端所需的技能与优化器、后端所需的技能不同，将它们分开可以使“前端人员”更容易地增强和维护他们的编译器部分。”后端人员“可以专注于中间代码的优化和目标平台机器代码的生成。</li>
</ul>
<h5 id="LLVM编译过程分析："><a href="#LLVM编译过程分析：" class="headerlink" title="LLVM编译过程分析："></a>LLVM编译过程分析：</h5><ol>
<li><strong>词法分析</strong>： 将源代码中的所有字符切分成记号(Token)的序列。包括了词法分析器、记号序列化生成器和扫描器，不过扫描器常常作为词法分析器的第一阶段。</li>
<li><strong>语法分析</strong>： 分析符合一定语法规则的一串符号，它通常会生成一个抽象语法树（AST - Abstract Syntax tree），用于表示记号之间的语法关系。</li>
<li><strong>语义分析</strong>： 通过语法分析的解析后，这个过程将从源代码中收集必要的语义信息，通常包括类型检查、在使用之前确保声明了变量等等。</li>
<li><strong>中间代码(IR)生成</strong>：代码在这个阶段会转换为中间表示式(IR)，这是一种中立的语言，与源语言(前端)和机器(后端)无关。</li>
<li><strong>优化中间表达式。</strong> 中间代码常常会有冗余和死代码的情况出现，而优化器可以处理这些问题以获得更优异的性能。</li>
<li><strong>生成目标代码</strong>： 最后后端会生成在目标机器上运行的机器码，我们也将其称之为目标代码。</li>
</ol>
<p>从上述分析可以看出在LLVM架构下的编译器是如何一步一步将我们写源代码编译成机器可执行的代码的。通常，狭义的LLVM仅包括优化器和编译后端，也就是只负责IR的优化和目标代码的生成。然而，广义上的LLVM则是指所有的三个阶段、完整的编译工具链，以及一整套的SDK编译器开发技术体系，我们通常称之为：LLVM集合。</p>
<p>下面我们将引用一张图来表示完整的LLVM工具链集合的六大执行单元：</p>
<p><img src="https://i.loli.net/2019/05/19/5ce0c30ea685f11517.png" alt="img3"></p>
<h4 id="Clang"><a href="#Clang" class="headerlink" title="Clang"></a>Clang</h4><p>Clang是LLVM编译工具集中的一个重要成员，由C++编写，是C、C++、Objective-C/C++ 的编译前端。</p>
<p>Clang的开发目标是提供一个可以替代GCC的前端编译器。与GCC相比，Clang是一个重新设计的编译器前端，具有一系列优点，例如模块化，代码简单易懂，占用内存小以及容易扩展和重用等。由于 Clang 在设计上的优异性，使得 Clang 非常适合用于设计源代码级别的分析和转化工具。Clang 也已经被应用到一些重要的开发领域，如 Static Analysis 是一个基于 Clang 的静态代码分析工具。</p>
<p>由于 GNU 编译器套装 (GCC) 系统庞大，而且 Apple 大量使用的 Objective-C 在 GCC 中优先级较低，同时 GCC 作为一个纯粹的编译系统，与 IDE 配合并不优秀，Apple 决定从零开始写 C family 的前端，也就是基于 LLVM 的 Clang 了。Clang 由 Apple 公司开发，源代码授权使用 BSD 的开源授权。</p>
<h5 id="Clang-的特性"><a href="#Clang-的特性" class="headerlink" title="Clang 的特性"></a>Clang 的特性</h5><p>相比于 GCC，Clang 具有如下优点：</p>
<ul>
<li><strong>编译速度快</strong>：在特定平台上，Clang 的编译速度显著的快过 GCC。</li>
<li><strong>占用内存小</strong>：Clang 生成的 AST 所占用的内存是 GCC 的五分之一左右。</li>
<li><strong>模块化设计</strong>：Clang 采用基于库的模块化设计，易于 IDE 集成及其他用途的重用。</li>
<li><strong>诊断信息可读性强</strong>：在编译过程中，Clang 创建并保留了大量详细的元数据 (metadata)，有利于调试和错误报告，例如Xcode中对错误精确的标红提示，以及给出快捷修复建议等。</li>
<li><strong>设计清晰简单</strong>：容易理解，易于扩展增强，与代码基础古老的 GCC 相比，学习曲线平缓。</li>
</ul>
<p>当前 Clang 还处在不断完善过程中，相比于 GCC, Clang 在以下方面还需要加强：</p>
<ul>
<li>支持更多语言：GCC 除了支持 C/C++/Objective-C, 还支持 Fortran/Pascal/Java/Ada/Go 和其他语言。Clang 目前支持的语言有 C/C++/Objective-C/Objective-C++。</li>
<li>加强对 C++ 的支持：Clang 对 C++ 的支持依然落后于 GCC，Clang 还需要加强对 C++ 提供全方位支持。</li>
<li>支持更多平台：GCC 流行的时间比较长，已经被广泛使用，对各种平台的支持也很完备。Clang 目前支持的平台有 Linux/Windows/Mac OS。</li>
</ul>
<h5 id="Clang的应用"><a href="#Clang的应用" class="headerlink" title="Clang的应用"></a>Clang的应用</h5><p>Clang作为编译前端，对源代码进行词法分析和语法分析，并将分析结果转换为抽象语法树（AST），最后生成IR中间代码提交给LLVM做下一步的优化。下面我们将从应用的角度讲一下，Clang是如何进行这些分析的。</p>
<p>首先，我们在终端创建一个main.m 文件，示例代码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="comment">// main.m</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> a;</div><div class="line">    <span class="keyword">int</span> b = <span class="number">10</span>;</div><div class="line">    </div><div class="line">    a = b;</div><div class="line">    <span class="keyword">return</span> a;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后，<strong>Clang会对代码进行词法分析，将代码切分成Token</strong>，可通过如下命令来查看所有的Token：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">clang -fmodules -E -Xclang -dump-tokens main.m</div></pre></td></tr></table></figure>
<p>输入的Token序列打印如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">int 'int'	 [StartOfLine]	Loc=&lt;main.m:2:1&gt;</div><div class="line">identifier 'main'	 [LeadingSpace]	Loc=&lt;main.m:2:5&gt;</div><div class="line">l_paren '('		Loc=&lt;main.m:2:9&gt;</div><div class="line">r_paren ')'		Loc=&lt;main.m:2:10&gt;</div><div class="line">l_brace '&#123;'		Loc=&lt;main.m:2:11&gt;</div><div class="line">int 'int'	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:3:5&gt;</div><div class="line">identifier 'a'	 [LeadingSpace]	Loc=&lt;main.m:3:9&gt;</div><div class="line">semi ';'		Loc=&lt;main.m:3:10&gt;</div><div class="line">int 'int'	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:4:5&gt;</div><div class="line">identifier 'b'	 [LeadingSpace]	Loc=&lt;main.m:4:9&gt;</div><div class="line">equal '='	 [LeadingSpace]	Loc=&lt;main.m:4:11&gt;</div><div class="line">numeric_constant '10'	 [LeadingSpace]	Loc=&lt;main.m:4:13&gt;</div><div class="line">semi ';'		Loc=&lt;main.m:4:15&gt;</div><div class="line">identifier 'a'	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:6:5&gt;</div><div class="line">equal '='	 [LeadingSpace]	Loc=&lt;main.m:6:7&gt;</div><div class="line">identifier 'b'	 [LeadingSpace]	Loc=&lt;main.m:6:9&gt;</div><div class="line">semi ';'		Loc=&lt;main.m:6:10&gt;</div><div class="line">return 'return'	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:8:5&gt;</div><div class="line">identifier 'a'	 [LeadingSpace]	Loc=&lt;main.m:8:12&gt;</div><div class="line">semi ';'		Loc=&lt;main.m:8:13&gt;</div><div class="line">r_brace '&#125;'	 [StartOfLine]	Loc=&lt;main.m:9:1&gt;</div><div class="line">eof ''		Loc=&lt;main.m:9:2&gt;</div></pre></td></tr></table></figure>
<p>这个命令的作用是，显示每个 Token 的类型、值，以及位置。包括：关键字（比如：if、else、for…）、标识符（变量名）、字面量（值、数字、字符串）、特殊字符（加减乘除符号等）。</p>
<p>接下来，会进行语法分析，将输出的Token先按照语法组合成语义，生成节点，然后将这些节点按照层级关系构成抽象语法树（AST）。</p>
<p>在终端中执行如下命令即可看到main.m 文件源码的语法树：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">clang -fmodules -fsyntax-only -Xclang -ast-dump main.m</div></pre></td></tr></table></figure>
<p>输出的AST代码如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><div class="line">TranslationUnitDecl 0x7fbae500c0e8 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt;</div><div class="line">|-TypedefDecl 0x7fbae500c660 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __int128_t '__int128'</div><div class="line">| `-BuiltinType 0x7fbae500c380 '__int128'</div><div class="line">|-TypedefDecl 0x7fbae500c6d0 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __uint128_t 'unsigned __int128'</div><div class="line">| `-BuiltinType 0x7fbae500c3a0 'unsigned __int128'</div><div class="line">|-TypedefDecl 0x7fbae500c770 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit SEL 'SEL *'</div><div class="line">| `-PointerType 0x7fbae500c730 'SEL *'</div><div class="line">|   `-BuiltinType 0x7fbae500c5c0 'SEL'</div><div class="line">|-TypedefDecl 0x7fbae500c858 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit id 'id'</div><div class="line">| `-ObjCObjectPointerType 0x7fbae500c800 'id'</div><div class="line">|   `-ObjCObjectType 0x7fbae500c7d0 'id'</div><div class="line">|-TypedefDecl 0x7fbae500c938 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit Class 'Class'</div><div class="line">| `-ObjCObjectPointerType 0x7fbae500c8e0 'Class'</div><div class="line">|   `-ObjCObjectType 0x7fbae500c8b0 'Class'</div><div class="line">|-ObjCInterfaceDecl 0x7fbae500c990 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit Protocol</div><div class="line">|-TypedefDecl 0x7fbae500ccf8 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __NSConstantString 'struct __NSConstantString_tag'</div><div class="line">| `-RecordType 0x7fbae500cb00 'struct __NSConstantString_tag'</div><div class="line">|   `-Record 0x7fbae500ca60 '__NSConstantString_tag'</div><div class="line">|-TypedefDecl 0x7fbae500cd90 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __builtin_ms_va_list 'char *'</div><div class="line">| `-PointerType 0x7fbae500cd50 'char *'</div><div class="line">|   `-BuiltinType 0x7fbae500c180 'char'</div><div class="line">|-TypedefDecl 0x7fbae5043688 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __builtin_va_list 'struct __va_list_tag [1]'</div><div class="line">| `-ConstantArrayType 0x7fbae5043630 'struct __va_list_tag [1]' 1</div><div class="line">|   `-RecordType 0x7fbae50434a0 'struct __va_list_tag'</div><div class="line">|     `-Record 0x7fbae5043400 '__va_list_tag'</div><div class="line">`-FunctionDecl 0x7fbae5043730 &lt;main.m:2:1, line:9:1&gt; line:2:5 main 'int ()'</div><div class="line">  `-CompoundStmt 0x7fbae5043a80 &lt;col:11, line:9:1&gt;</div><div class="line">    |-DeclStmt 0x7fbae50438a0 &lt;line:3:5, col:10&gt;</div><div class="line">    | `-VarDecl 0x7fbae5043840 &lt;col:5, col:9&gt; col:9 used a 'int'</div><div class="line">    |-DeclStmt 0x7fbae5043950 &lt;line:4:5, col:15&gt;</div><div class="line">    | `-VarDecl 0x7fbae50438d0 &lt;col:5, col:13&gt; col:9 used b 'int' cinit</div><div class="line">    |   `-IntegerLiteral 0x7fbae5043930 &lt;col:13&gt; 'int' 10</div><div class="line">    |-BinaryOperator 0x7fbae5043a00 &lt;line:6:5, col:9&gt; 'int' '='</div><div class="line">    | |-DeclRefExpr 0x7fbae5043968 &lt;col:5&gt; 'int' lvalue Var 0x7fbae5043840 'a' 'int'</div><div class="line">    | `-ImplicitCastExpr 0x7fbae50439e8 &lt;col:9&gt; 'int' &lt;LValueToRValue&gt;</div><div class="line">    |   `-DeclRefExpr 0x7fbae50439a8 &lt;col:9&gt; 'int' lvalue Var 0x7fbae50438d0 'b' 'int'</div><div class="line">    `-ReturnStmt 0x7fbae5043a68 &lt;line:8:5, col:12&gt;</div><div class="line">      `-ImplicitCastExpr 0x7fbae5043a50 &lt;col:12&gt; 'int' &lt;LValueToRValue&gt;</div><div class="line">        `-DeclRefExpr 0x7fbae5043a28 &lt;col:12&gt; 'int' lvalue Var 0x7fbae5043840 'a' 'int'</div></pre></td></tr></table></figure>
<p>其中TranslationUnitDecl是根节点，表示一个编译单元；Decl表示一个声明；Expr表示的是表达式；Literal表示字面量，是一个特殊的Expr；Stmt表示语句。</p>
<h4 id="Optimiser"><a href="#Optimiser" class="headerlink" title="Optimiser"></a>Optimiser</h4><p>通过上述Clang的介绍，以及Clang是如何将main.m文件中的源代码一步步转换为AST的，最后Clang会将AST 转换为中间代码IR，交由优化器（Optimiser）来做代码优化。</p>
<p><img src="https://i.loli.net/2019/05/19/5ce0d87ebcb7339465.png" alt="img4"></p>
<p>从上图可以看出，在LLVM IR优化阶段，优化器被设计为由若干个Pass组成的集合，每个优化模块(Pass)都能读入IR，完成一些任务后，输出优化后的IR。</p>
<p>常见优化模块的例子是内联优化，它会将函数体替换为<strong>调用点(call sites)</strong>，还可以将表达式重新组合(expression reassociation)、移动循环不变代码(loop-invariant code motion)等等。根据优化级别的不同，可以调用不同的优化模块：例如，Clang编译器使用<code>-O0</code>（无优化状态）参数进行编译时不调用pass，在使用<code>-O3</code>时将会调用67个pass来进行IR的优化（从LLVM 2.8开始）。</p>
<p>由于优化器的模块化设计，Pass也可以进行自主开发，实现对LLVM 优化器的改进和增强。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>本文讲解了LLVM编译器工具集的历史和由来，以及作为现代应用最广泛的编译器之一，介绍了其优良的架构设计，可重用的模块化构建思想。同时，也介绍了Clang编译前端的特性已及编译过程的举例分析。</p>
<p>通过对LLVM编译工具集的学习，深刻的感受到 了它的强大之处，先进的设计理念，想必能在以后的编程中提升对代码优化、底层思维逻辑的理解能力。</p>
<p>希望和我一样对LLVM编译器感兴趣的同学，能学习到对自己有用的知识，提高对编程的底层认知能力。</p>
<h4 id="参考-引用"><a href="#参考-引用" class="headerlink" title="参考/引用"></a>参考/引用</h4><blockquote>
<p><a href="http://llvm.org/" target="_blank" rel="noopener">http://llvm.org/</a></p>
<p><a href="https://www.kancloud.cn/yelbee111/annhub/991863" target="_blank" rel="noopener">https://www.kancloud.cn/yelbee111/annhub/991863</a></p>
<p><a href="http://kuanghy.github.io/2015/08/20/llvm-abstruct" target="_blank" rel="noopener">http://kuanghy.github.io/2015/08/20/llvm-abstruct</a></p>
</blockquote>


                <hr>

                

                <ul class="pager">
                    
                    
                        <li class="next">
                            <a href="/2019/03/10/iOS代码混淆之编译优化(三)/" data-toggle="tooltip" data-placement="top" title="iOS代码混淆之编译优化(三)">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#LLVM" title="LLVM">LLVM</a>
                        
                          <a class="tag" href="/tags/#Clang" title="Clang">Clang</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://huangxuan.me" target="_blank">Hux Blog</a></li>
                    
                        <li><a href="https://unsplash.com/" target="_blank">Unsplash</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/jerrywangjing">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/jing-wang-68-66">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/JerryWang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/jerrywangjing">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Jerry&#39;s Blog 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://jerrywangjing.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-136960405-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="https://jerrywangjing.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
